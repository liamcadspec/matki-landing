<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Launching Matki Smart Survey…</title>

    <script>
        const params = new URLSearchParams(window.location.search);

        const driveItemId = params.get("driveItemId");
        const fileName = params.get("fileName");
        const rawShareUrl = params.get("shareUrl");

        // === NEW: Write debug info to the page ===
        function showDebug() {
            const panel = document.getElementById("debug-panel");
            panel.textContent =
                "DEBUG landing page params:\n\n" +
                "driveItemId: " + driveItemId + "\n" +
                "fileName:    " + fileName + "\n" +
                "rawShareUrl: " + rawShareUrl + "\n";
        }

        // Call debug immediately so we see the values before redirect
        window.addEventListener("DOMContentLoaded", showDebug);

        if (!driveItemId || !fileName || !rawShareUrl) {
            document.body.innerHTML =
                "<p style='color:red;'>Missing required parameters. Cannot launch Matki Smart Survey.</p>";
            throw new Error("Missing deep link parameters");
        }

        // Clean the shareUrl by stripping query parameters
        function cleanShareUrl(url) {
            return url.split('?')[0];
        }

        const cleanedShareUrl = cleanShareUrl(rawShareUrl);

        const deepLink =
            `matzip://open?driveItemId=${encodeURIComponent(driveItemId)}` +
            `&fileName=${encodeURIComponent(fileName)}` +
            `&shareUrl=${encodeURIComponent(cleanedShareUrl)}`;

        // Delay redirect slightly so debug panel is visible
        setTimeout(() => {
            window.location.href = deepLink;
        }, 800);
    </script>
</head>
<body>
    <p>Launching Matki Smart Survey…</p>

    <!-- === NEW: Debug panel visible on page === -->
    <div id="debug-panel"
         style="white-space: pre-wrap;
                background: #222;
                color: #0f0;
                padding: 12px;
                margin-top: 20px;
                font-family: Consolas, monospace;
                border: 1px solid #555;">
        Loading debug info…
    </div>
</body>
</html>
